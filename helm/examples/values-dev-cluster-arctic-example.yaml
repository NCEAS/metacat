## override values.yaml with values to use for running on the NCEAS dev cluster
## EXAMPLE FILE FROM TEST ARCTIC DATA CENTER INSTALLATION, FOR REFERENCE ONLY
##
## examples:
## from local helm chart:
##  helm install myrelease -n mynamespace ./helm -f ./helm/examples/values-dev-cluster-example.yaml
##
## or from pre-packaged chart:
##  helm install myrelease -n mynamespace oci://ghcr.io/nceas/charts/metacat --version 1.2.0 \
##       -f ./helm/examples/values-dev-cluster-example.yaml \
##       --debug --render-subchart-notes
##
## see values.yaml for full documentation on the following parameters
##

## set once here, for both metacat and indexer:
## Omit for production - otherwise logging is too verbose
##
## NOTE: can also edit the logging level the metacat configMap, and it will be picked up
## automatically without a pod restart
##
debug: &debug false

global:
  metacatUiThemeName: "arctic"
  metacatUiWebRoot: "/catalog"
  metacatExternalBaseUrl: "https://metacat-dev.test.dataone.org/"
  d1ClientCnUrl: "https://cn-stage.test.dataone.org/cn"
  storageClass: &storageClassName csi-cephfs-sc
  ephemeralVolumeStorageClass: csi-cephfs-sc-ephemeral
  ## Use your own release name instead of metacatbrooke
  passwordsSecret: &passwordSecretName metacatbrooke-metacat-secrets

metacatui:
  livenessProbe:
    failureThreshold: 4
    initialDelaySeconds: 30
    httpGet:
      path: /catalog/config/config.js
      port: http

  readinessProbe:
    failureThreshold: 4
    initialDelaySeconds: 30
    httpGet:
      path: /catalog/config/config.js
      port: http

metacat:
  server.name: metacat-dev.test.dataone.org
  auth.administrators: http://orcid.org/0000-0002-1472-913X;http://orcid.org/0000-0002-1209-5268

  cn.server.publiccert.filename: /var/metacat/pubcerts/DataONETestIntCA.pem

#  storage.hashstore.disableConversion: true

  ## DataONE Member Node (MN) Parameters
  dataone.certificate.fromHttpHeader.enabled: true
  dataone.autoRegisterMemberNode: 2024-01-25
  dataone.nodeId: "urn:node:TestBROOKELT"
  dataone.subject: "CN=urn:node:TestBROOKELT,DC=dataone,DC=org"
  dataone.nodeName: Dev Deployment of Arctic Data Center
  dataone.nodeDescription: |
    The US National Science Foundation Arctic Data Center operates as the primary repository
    supporting the NSF Arctic community for data preservation and access. The Center helps the
    research community reproducibly preserve and discover all products of NSF-funded science
    in the Arctic, including data, metadata, software, documents, and provenance that link
    these in an open and reproducible way.

  dataone.contactSubject: http://orcid.org/0000-0002-1472-913X
  dataone.nodeSynchronize: true
  dataone.nodeReplicate: true
  dataone.replicationpolicy.default.numreplicas: "1"

persistence:
  storageClass: *storageClassName
  size: 100Gi
  accessModes:
    - ReadWriteMany
  ## Use your own release name instead of metacatbrooke
  volumeName: cephfs-metacatbrooke-metacat

image:
  # tag: TEST
  pullPolicy: Always
  debug: *debug

ingress:
  defaultBackend:
    enabled: true
    service:
      name: wpbrooke-wordpress
      port:
        number: 80

  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
############## EXPERIMENTAL CORS STUFF:

    nginx.ingress.kubernetes.io/cors-allow-origin: "$http_origin"

    # # # # # works for non-logged in stuff:
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "Access-Control-Allow-Origin: $http_origin";
    nginx.ingress.kubernetes.io/cors-allow-headers: "Authorization, Content-Type, Origin, Cache-Control"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, OPTIONS"
    nginx.ingress.kubernetes.io/cors-expose-headers: "*, X-Project-Key"
    nginx.ingress.kubernetes.io/cors-max-age: "1728000"
    nginx.ingress.kubernetes.io/enable-cors: "true"

####### OTHER EXPERIMENTS:
# 1:
#    nginx.ingress.kubernetes.io/configuration-snippet: |-
#      if ($request_method = 'OPTIONS') {
#      add_header Access-Control-Allow-Origin "$http_origin";
#      add_header Access-Control-Allow-Methods "GET, POST, PUT, OPTIONS";
#      add_header Access-Control-Allow-Headers "Authorization, Content-Type, Origin, Cache-Control";
#      add_header Content-Type "text/plain charset=UTF-8";
#      add_header Content-Length 0;
#      return 204;
#      }
#
# 2:
#    nginx.ingress.kubernetes.io/configuration-snippet: |-
#      # if ($http_origin ~* "^https?://(example.com|example2.com)$") {
#      if ($http_origin ~* "^https?://[^/]+") {
#          set $allow_origin $http_origin;
#      }
#      more_set_headers 'Access-Control-Allow-Origin: $allow_origin';
#      more_set_headers 'Access-Control-Allow-Credentials: true';
#      more_set_headers 'Access-Control-Allow-Methods: GET, POST, PUT, OPTIONS';
#      more_set_headers 'Access-Control-Allow-Headers: Authorization, Content-Type, Origin, Cache-Control';
#      if ($request_method = 'OPTIONS') {
#          more_set_headers 'Access-Control-Max-Age: 1728000';
#          more_set_headers 'Content-Type: text/plain charset=UTF-8';
#          more_set_headers 'Content-Length: 0';
#          return 204;
#      }
#
# 3:
#    nginx.ingress.kubernetes.io/configuration-snippet: |
#      # Clear existing CORS headers
#      proxy_set_header Access-Control-Allow-Origin "";
#      proxy_set_header Access-Control-Allow-Methods "";
#      proxy_set_header Access-Control-Allow-Headers "";
#
#      # Set new CORS headers
#      if ($http_origin ~* "^https?://[^/]+") {
#        add_header Access-Control-Allow-Origin "$http_origin";
#      }
#      add_header Access-Control-Allow-Methods "GET, POST, PUT, OPTIONS";
#      add_header Access-Control-Allow-Headers "Authorization, Content-Type, Origin, Cache-Control";
#      add_header Access-Control-Allow-Credentials "true";
#
#      # Handle OPTIONS preflight requests
#      if ($request_method = 'OPTIONS') {
#        add_header Content-Type "text/plain charset=UTF-8";
#        add_header Content-Length 0;
#        return 204;
#      }

  tls:
    - hosts: [] # defaults to metacat.server.name
      secretName: ingress-nginx-tls-cert

podSecurityContext:
  runAsNonRoot: true

postgresql:
  ## @param postgresqlDataDir PostgreSQL data dir folder
  ##
  postgresqlDataDir: /bitnami/postgresql/14/main

  primary:
    extendedConfiguration: |
      max_connections = 250
      max_wal_size=16384
      min_wal_size=4096
      shared_buffers = 1280MB

    persistence:
      size: 10Gi
      selector:
        matchLabels:
          ## Use your own release name instead of metacatbrooke
          metacatVolumeName: cephfs-metacatbrooke-metacat-postgresdata

  auth:
    existingSecret: *passwordSecretName

dataone-indexer:
  # increase minReplicas from default 3
  autoscaling:
    minReplicas: 50
    targetCPUUtilizationPercentage: 80

  image:
    pullPolicy: Always
    debug: *debug

  topologySpreadConstraints:
    - maxSkew: 2
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: d1index

  idxworker:
    # this actually puts container in debug loop mode - no indexer running
    debug: false

  rabbitmq:
    auth:
      existingPasswordSecret: *passwordSecretName

  solr:
    extraVolumes:
      - name: solr-config
        configMap:
          ## Use your own release name instead of metacatbrooke
          name: metacatbrooke-indexer-configfiles
          defaultMode: 0777

####################################################################################################
## FOR DEBUGGING ONLY
####################################################################################################
##
## probes will kill remote debugger
#
#livenessProbe:
#  enabled: false
#readinessProbe:
#  enabled: false
